<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Reddit Loader</title>
        <style type="text/css">
            body{margin:40px
                auto;max-width:650px;line-height:1.6;font-size:18px;color:#444;padding:0
                10px}h1,h2,h3{line-height:1.2}
                img{
                    width: 100%;
                    height: auto
                }
                #loading {
                    font-size: 10px;
                }
                </style>
    </head>
    <body>
        <div id="wrapper">
            <textarea id="myid" rows="20" cols="50"></textarea>
            <br>
            <button onclick="run()">LOAD</button>
        </div>
        <span id="myspan"></span>
        <div id="output" onclick="run()""></div>
    </body>

<script>

//lets define an array first to see whether we went to that list
var visitedLinks =[];
let world = {};
var shownImages = [];

//at some pt images will end it will be a problem
//can create another dict to hold count values -- better soln?


async function fetchURL(word) {
    if(visitedLinks.includes(word)) {
        console.log("This link is visited before. Getting link from the cache.");
        show(world[word], word);
        return; //do we need this?
    }
    else {
        visitedLinks.push(word);
    }

    let url = "https://www.reddit.com/r/" + word + "/.json?limit=20";


    //TODO: if the subreddit is invalid, just dont care about it

    try {
        console.log("i am fetching something. beware!")
        const response = await fetch(url);
        const res = await response.json();
        let myArr = [];
        const formats = [".gif",".png",".jpg",".jpeg"];
        let imageLink;
        for(let i=0;i<res.data.children.length;i++){
            imageLink = res.data.children[i].data.url;
            if(formats.some(char => imageLink.includes(char) )) {
                myArr.push(imageLink);
            }

        }
        //console.log(myArr);
        world[word] = myArr;      
        //console.log(world["watches"]); //works
        show(world[word], word);
        
        
        
    }
    catch (error) {
        console.error(`error fetching data ${error}`);
        
    }
  }

function show(arr, word) {
    let rnd = getRand(arr.length);
    let output = document.getElementById("output");
    if(shownImages.includes(arr[rnd])) {
        console.log("shown this image before. reloading.")
        run();
    }
    
    document.getElementById("myspan").innerHTML = `Subreddit: <b>${word}</b> <br><a href=${arr[rnd]}>${arr[rnd]}</a>`;
    output.innerHTML = `<img src='${arr[rnd]}'>`;
    shownImages.push(arr[rnd]);
}

function getRand(y) {
    return Math.floor(Math.random() * (y));
}

/*
let word = "watches";
let url = "https://www.reddit.com/r/watches/.json?limit=10";
fetchURL(word);
*/

function run() {
    let subs = [];
    subs = document.getElementById("myid").value.split('\n');
    document.getElementById("wrapper").style.display = 'none';
    let idx = getRand(subs.length);
    fetchURL(subs[idx]);
}


</script>
</html>
